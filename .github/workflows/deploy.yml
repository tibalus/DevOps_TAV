name: Deploy to Cloud Run

on:
  push:
    tags:
      - 'v*.*.*'

env:
  TR_DOCKER_USERNAME: ${{ secrets.TR_DOCKER_USERNAME }}
  GCP_PROJECT_ID: ${{ secrets.TR_GCP_PROJECT_ID }}
  GCP_REGION: ${{ secrets.GCP_REGION }}
  DB_INSTANCE: ${{ secrets.DB_INSTANCE }}
  DB_NAME: ${{ secrets.DB_NAME }}
  DB_USER: ${{ secrets.DB_USER }}
  LOKI_URL: ${{ secrets.LOKI_URL }}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Récupération du code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Extraction de la version
      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Deploying version: $VERSION"

      # 3. Connexion à Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.TR_DOCKER_USERNAME }}
          password: ${{ secrets.TR_DOCKER_TOKEN }}

      # 4. Build et push de l'image de l'API
      - name: Build and push API image
        run: |
          docker build -f docker/Dockerfile -t ${{ env.TR_DOCKER_USERNAME }}/symfony-crud-api:${{ steps.version.outputs.VERSION }} .
          docker tag ${{ env.TR_DOCKER_USERNAME }}/symfony-crud-api:${{ steps.version.outputs.VERSION }} ${{ env.TR_DOCKER_USERNAME }}/symfony-crud-api:latest
          docker push ${{ env.TR_DOCKER_USERNAME }}/symfony-crud-api:${{ steps.version.outputs.VERSION }}
          docker push ${{ env.TR_DOCKER_USERNAME }}/symfony-crud-api:latest

      # 5. Build et push de l'image Fluent Bit
      - name: Build and push Fluent Bit image
        run: |
          docker build -f docker/Dockerfile.fluent-bit -t ${{ env.TR_DOCKER_USERNAME }}/fluent-bit:latest ./fluent-bit
          docker push ${{ env.TR_DOCKER_USERNAME }}/fluent-bit:latest

      # 6. Configuration du SDK Google Cloud
      - name: Setup Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          export_default_credentials: true

      # 7. Exécution des migrations de base de données
      - name: Run database migrations
        run: |
          # Build migration image
          docker build -f docker/Dockerfile.migrations -t migrations-runner .
          
          # Run migrations via Cloud SQL Proxy
          docker run --rm \
            -e DATABASE_URL="mysql://${{ env.DB_USER }}:${{ secrets.DB_PASSWORD }}@127.0.0.1:3306/${{ env.DB_NAME }}" \
            -e INSTANCE_CONNECTION_NAME="${{ env.GCP_PROJECT_ID }}:${{ env.GCP_REGION }}:${{ env.DB_INSTANCE }}" \
            -e GCP_SA_KEY="${{ secrets.GCP_SA_KEY }}" \
            migrations-runner

      # 8. Mise à jour du fichier de configuration Cloud Run
      - name: Update Cloud Run configuration
        run: |
          sed -i "s/\${VERSION}/${{ steps.version.outputs.VERSION }}/g" cloud-run-service.yaml
          sed -i "s/\${TR_DOCKER_USERNAME}/${{ env.TR_DOCKER_USERNAME }}/g" cloud-run-service.yaml
          sed -i "s/\${GCP_PROJECT_ID}/${{ env.GCP_PROJECT_ID }}/g" cloud-run-service.yaml
          sed -i "s/\${GCP_REGION}/${{ env.GCP_REGION }}/g" cloud-run-service.yaml
          sed -i "s/\${DB_INSTANCE}/${{ env.DB_INSTANCE }}/g" cloud-run-service.yaml
          sed -i "s/\${DB_NAME}/${{ env.DB_NAME }}/g" cloud-run-service.yaml
          sed -i "s/\${DB_USER}/${{ env.DB_USER }}/g" cloud-run-service.yaml
          sed -i "s|\${LOKI_URL}|${{ env.LOKI_URL }}|g" cloud-run-service.yaml

      # 9. Déploiement sur Cloud Run
      - name: Deploy to Cloud Run
        run: |
          gcloud run services replace cloud-run-service.yaml \
            --region=${{ env.GCP_REGION }}
          
          # Configure les permissions pour autoriser les invocations non authentifiées
          gcloud run services add-iam-policy-binding symfony-crud-api \
            --region=${{ env.GCP_REGION }} \
            --member="allUsers" \
            --role="roles/run.invoker"

      - name: Get service URL
        run: |
          SERVICE_URL=$(gcloud run services describe symfony-crud-api \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')
          echo "Service deployed at: $SERVICE_URL"